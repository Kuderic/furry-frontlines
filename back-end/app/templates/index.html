<!DOCTYPE html>
<html>
    <head>
        <title>Furry Frontlines XV</title>
        <link rel="stylesheet" type="text/css" href="/static/styles/main.css">
        <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
        
    </head>
    <body>
        <script src="/static/js/script.js"></script>
        
        <div id="topContainer">
            <h1>Furry Frontlines XV</h1>
            <input type="text" id="messageInput" placeholder="Type your message here">
            <button onclick="sendMessage()">Send Message</button>
            <ul id="messagesList"></ul>
        </div>
        <div id="canvasContainer">
            <canvas id="gameCanvas" width="1200" height="1080"></canvas>
        </div>
        <script>
            // WebSocket logic
            // Determine WebSocket URL based on the environment
            let wsUrl;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                wsUrl = "ws://localhost:8000/ws"; // Local server
            } else {
                wsUrl = "ws://ec2-3-133-93-0.us-east-2.compute.amazonaws.com:8000/ws"; // Production server
            }

            let ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log("WebSocket connection established");
            };

            ws.onmessage = function(event) {
                handleMessage(event.data)
            };

            ws.onclose = function(event) {
                console.log("WebSocket connection closed", event);
            };

            ws.onerror = function(error) {
                console.error("WebSocket error:", error);
            };

            // Game logic
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            const player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                speed: 5
            }


            const heldKeys = {
                w: false,
                a: false,
                s: false,
                d: false
            };


            function updatePlayerPosition() {
                console.log('updating player position')
                const starting_pos = {x: player.x, y: player.y}
                if (heldKeys.w) {
                    player.y -= player.speed;
                }
                if (heldKeys.s) {
                    player.y += player.speed;
                }
                if (heldKeys.a) {
                    player.x -= player.speed;
                }
                if (heldKeys.d) {
                    player.x += player.speed;
                }
                
                if (player.x !== starting_pos.x || player.y !== starting_pos.y) {
                    // Send updated position to the server if WebSocket is open
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'move',
                            x: player.x,
                            y: player.y
                        }));
                    }
                }

                drawPlayer();
                requestAnimationFrame(updatePlayerPosition);
            }


            document.addEventListener('keydown', (event) => {
                console.log("keydown");
                if (event.key in heldKeys) {
                    heldKeys[event.key] = true;
                }
            });

            document.addEventListener('keyup', (event) => {
                console.log("keyup");
                if (event.key in heldKeys) {
                    heldKeys[event.key] = false;
                }
            });

            function drawPlayer() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'blue';
                ctx.fillRect(player.x, player.y, 50, 50);
            }
            
            // Start the update loop
            requestAnimationFrame(updatePlayerPosition);

            // Parse websocket JSON message
            function handleMessage(data) {
                let parsedData = JSON.parse(data);
                console.log("received server message " + parsedData);
                if (parsedData.type === "chat_message") {
                    console.log('is chat message')
                    displayMessage(parsedData.sender_ip, parsedData.data)
                }
                else if (parsedData.type === "update") {
                    player.x = parsedData.x;
                    player.y = parsedData.y;
                } else {
                    console.log('idk what kind of message this is')
                }
            }
            
            // Send message button logic
            function sendMessage() {
                let message = document.getElementById("messageInput").value;
                if (message) {
                    let data = JSON.stringify({type: "chat_message", data: message});
                    ws.send(data);
                    document.getElementById("messageInput").value = ''; // Clear the input field after sending the message
                } else {
                    alert("Please enter a message to send");
                }
            }

            function displayMessage(ip, message) {
                let messagesList = document.getElementById("messagesList");
                let messageItem = document.createElement("li");
                messageItem.textContent = ip+' says "'+message+'"';
                messagesList.appendChild(messageItem);
            }
        </script>
        <script>
            drawPlayer();
        </script>
    </body>
</html>
